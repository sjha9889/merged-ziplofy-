import{T as I,U,b as W,u as q,r as l,j as s,g as H,M as J,F as O}from"./index-C7S6h9OR.js";import{G as Q}from"./GridBackgroundWrapper-Du1VLjut.js";const Y=()=>{const{permissions:f,loading:h,error:m,fetchAll:K}=I(),{create:R}=U(),{activeStoreId:y}=W(),M=q(),[x,z]=l.useState(""),[v,p]=l.useState(new Set),[i,g]=l.useState(new Set),[N,D]=l.useState(""),[b,A]=l.useState(""),[w,S]=l.useState(!1);l.useEffect(()=>{f.length===0&&!h&&K().catch(()=>{})},[]);const o=l.useMemo(()=>{const e=new Map;f.forEach(a=>{e.set(a.key,{key:a.key,name:a.name,isLeaf:a.isLeaf??!0,parentKey:a.parentKey??null,order:a.order,resource:a.resource,children:[]})});const r=[];e.forEach(a=>{a.parentKey&&e.has(a.parentKey)?e.get(a.parentKey).children.push(a):r.push(a)});const t=a=>{a.sort((n,c)=>(n.order??0)-(c.order??0)||n.name.localeCompare(c.name)),a.forEach(n=>t(n.children))};return t(r),r},[f]),d=l.useMemo(()=>{const e=[],r=t=>{t.isLeaf||t.children.length===0?e.push(t.key):t.children.forEach(r)};return o.forEach(r),e},[o]);l.useEffect(()=>{g(e=>{const r=new Set(e);return r.forEach(t=>{d.includes(t)||r.delete(t)}),r})},[d]);const B=e=>{p(r=>{const t=new Set(r);return t.has(e)?t.delete(e):t.add(e),t})},j=e=>e.isLeaf||e.children.length===0?[e.key]:e.children.flatMap(j),F=e=>{const r=j(e),t=r.filter(a=>i.has(a));return{total:r.length,selected:t.length,checked:t.length===r.length&&r.length>0,indeterminate:t.length>0&&t.length<r.length}},T=e=>{const r=j(e),t=r.every(a=>i.has(a));g(a=>{const n=new Set(a);return t?r.forEach(c=>n.delete(c)):r.forEach(c=>n.add(c)),n})},P=()=>{i.size===d.length?g(new Set):g(new Set(d))},k=l.useMemo(()=>{const e=[],r=t=>{t.children.length>0&&(e.push(t.key),t.children.forEach(r))};return o.forEach(r),e},[o]),$=()=>{const e=k.every(r=>v.has(r));p(e?new Set:new Set(k))},E=l.useMemo(()=>{if(!x.trim())return o;const e=x.toLowerCase(),r=t=>{const a=t.name.toLowerCase().includes(e)||t.key.toLowerCase().includes(e),n=t.children.map(r).filter(c=>!!c);return a||n.length>0?{...t,children:n}:null};return o.map(r).filter(t=>!!t)},[o,x]),C=N.trim().length>0&&b.trim().length>0&&i.size>0&&!!y,G=async()=>{if(!(!C||!y))try{S(!0),await R({storeId:y,name:N.trim(),description:b.trim(),permissions:Array.from(i)}),M("/settings/users/roles")}finally{S(!1)}},L=(e,r=0)=>{const t=e.children.length>0,a=F(e),n=v.has(e.key)||!t,c=r*1.5;return s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center py-1.5",style:{paddingLeft:`${c}rem`},children:[t?s.jsx("button",{onClick:()=>B(e.key),className:"p-0.5 text-gray-600 hover:text-gray-700 mr-1",children:n?s.jsx(J,{className:"w-4 h-4"}):s.jsx(O,{className:"w-4 h-4"})}):s.jsx("div",{className:"w-6 mr-1"}),s.jsx("input",{type:"checkbox",ref:u=>{u&&(u.indeterminate=!a.checked&&a.indeterminate)},checked:a.checked,onChange:()=>T(e),className:"w-4 h-4 text-gray-900 focus:ring-gray-400 mr-2"}),s.jsx("span",{className:"text-sm text-gray-900",children:e.name}),t&&s.jsxs("span",{className:"text-xs text-gray-600 ml-auto mr-2",children:[a.selected,"/",a.total]})]}),t&&s.jsx("div",{className:n?"block":"hidden",children:e.children.map(u=>L(u,r+1))})]},e.key)};return s.jsx(Q,{children:s.jsxs("div",{className:"max-w-7xl mx-auto py-8 px-4",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsx("h1",{className:"text-xl font-medium text-gray-900",children:"Create role"}),C&&s.jsx("button",{onClick:G,disabled:w,className:"px-3 py-1.5 text-sm text-white bg-gray-900 hover:bg-gray-800 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed",children:w?"Saving...":"Save"})]}),s.jsx("div",{className:"border border-gray-200 bg-white p-4 mb-4",children:s.jsxs("div",{className:"flex flex-col gap-3",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Name"}),s.jsx("input",{type:"text",placeholder:"Name",value:N,onChange:e=>D(e.target.value),className:"w-full border border-gray-200 px-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Description"}),s.jsx("textarea",{placeholder:"Description",rows:2,value:b,onChange:e=>A(e.target.value),className:"w-full border border-gray-200 px-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 resize-y"})]})]})}),s.jsxs("div",{className:"border border-gray-200 bg-white p-4",children:[s.jsx("h2",{className:"text-base font-medium text-gray-900 mb-1",children:"Permissions"}),s.jsx("p",{className:"text-xs text-gray-600 mb-3",children:"Role category determines available permissions."}),h&&s.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[s.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-gray-900 rounded-full animate-spin"}),s.jsx("span",{className:"text-sm",children:"Loading permissionsâ€¦"})]}),m&&s.jsx("p",{className:"text-sm text-red-600",children:m}),!h&&!m&&s.jsxs("div",{className:"flex flex-col gap-3",children:[s.jsxs("div",{className:"relative",children:[s.jsx(H,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-600"}),s.jsx("input",{type:"text",placeholder:"Search",value:x,onChange:e=>z(e.target.value),className:"w-full border border-gray-200 bg-gray-50 pl-10 pr-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400"})]}),s.jsxs("div",{className:"flex items-center justify-between px-1",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"checkbox",ref:e=>{e&&(e.indeterminate=i.size>0&&i.size<d.length)},checked:i.size===d.length&&d.length>0,onChange:P,className:"w-4 h-4 text-gray-900 focus:ring-gray-400"}),s.jsx("span",{className:"text-sm text-gray-900 font-medium",children:"Select all permissions"})]}),s.jsx("button",{onClick:$,className:"text-xs text-gray-700 hover:underline",children:"Expand all"})]}),s.jsxs("div",{children:[E.map(e=>L(e)),E.length===0&&s.jsx("p",{className:"text-sm text-gray-600 mt-2",children:"No permissions match your search."})]})]}),!h&&!m&&o.length===0&&s.jsx("p",{className:"text-sm text-gray-600",children:"No permissions found."})]})]})})};export{Y as default};
