import{p as z,u as M,b as O,H as B,r as d,R as W,j as e}from"./index-C7S6h9OR.js";import{u as $,a as V,R as J,B as L,C as H,M as _,b as G,I as U,H as p,P as f}from"./style-B-Ob-YGb.js";import{B as i,T as o}from"./Box-Cgm3ZkZ8.js";import{P as I}from"./Paper-DocVmpOE.js";import{I as K}from"./IconButton-BnkdM8yk.js";import{A as Q}from"./ArrowBack-CB8ALDU6.js";import{F as X,I as Y,S as Z}from"./Select-Bus390RW.js";import{M as r}from"./MenuItem-HG7tTLPS.js";import{B as ee}from"./Button-CdPvNkrY.js";import"./createSvgIcon-Yi9Vo0kN.js";import"./DefaultPropsProvider-CZkfTDs_.js";import"./index-CCB_rw4P.js";import"./dividerClasses-Q3ucxvtD.js";const ue=()=>{const{automationId:u}=z(),R=M(),{activeStoreId:g}=O(),{flows:C,getByStoreId:w}=B(),l=d.useMemo(()=>C.find(t=>t._id===u),[C,u]);d.useEffect(()=>{!l&&g&&w(g).catch(()=>{})},[l,g,w]);const m=l?.flowData?.nodes||[],j=l?.flowData?.edges||[],[a,te,k]=$(m),[c,,S]=V(j),[n,N]=d.useState(null),[E,h]=d.useState(!1),x=d.useRef(null),{update:F}=B(),b=t=>t.map(s=>({id:s.id,type:s.type,position:s.position,data:s.data})),y=t=>t.map(s=>({id:s.id,source:s.source,target:s.target,label:s.label,style:s.style}));d.useEffect(()=>{x.current||(x.current={nodes:b(m),edges:y(j)},h(!1))},[u,m,j]);const D=W.useCallback(t=>{k(t);const s=x.current;if(s){const v=b(a);h(JSON.stringify(v)!==JSON.stringify(s.nodes))}},[k,a]),T=W.useCallback(t=>{S(t);const s=x.current;if(s){const v=y(c);h(JSON.stringify(v)!==JSON.stringify(s.edges))}},[S,c]),A=({data:t,selected:s})=>e.jsxs(i,{sx:{backgroundColor:s?"#f5f7ff":"white",border:`2px solid ${s?"#4f46e5":"#6366f1"}`,borderRadius:2,p:2,minWidth:150,position:"relative"},children:[e.jsx(p,{type:"target",position:f.Top,style:{visibility:"hidden"}}),e.jsx(o,{variant:"body1",sx:{fontWeight:600,textAlign:"center"},children:t.label||"Trigger"}),e.jsx(p,{type:"source",position:f.Bottom,style:{bottom:-8}})]}),P=({data:t,selected:s})=>e.jsxs(i,{sx:{backgroundColor:s?"#f5f7ff":"white",border:`2px solid ${s?"#4f46e5":"#6366f1"}`,borderRadius:2,p:2,minWidth:200,position:"relative"},children:[e.jsx(p,{type:"target",position:f.Top,style:{bottom:-8}}),e.jsx(o,{variant:"body1",sx:{fontWeight:600,textAlign:"center",mb:1},children:"Condition"}),t.variable&&e.jsxs(i,{sx:{mb:1,p:1,backgroundColor:"#f5f5f5",borderRadius:1},children:[e.jsx(o,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:.5},children:"Variable"}),e.jsx(o,{variant:"body2",sx:{fontWeight:500},children:t.variable}),t.operator&&e.jsxs(e.Fragment,{children:[e.jsx(o,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:"Operator"}),e.jsx(o,{variant:"body2",sx:{fontWeight:500},children:t.operator})]}),t.value&&e.jsxs(e.Fragment,{children:[e.jsx(o,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:"Value"}),e.jsx(o,{variant:"body2",sx:{fontWeight:500},children:t.value})]})]}),e.jsx(p,{type:"source",position:f.Bottom,style:{bottom:-8}})]}),q=d.useMemo(()=>({trigger:A,condition:P}),[]);return e.jsxs(i,{sx:{height:"calc(100vh - 64px)",width:"100%",position:"relative"},children:[e.jsxs(I,{elevation:1,sx:{position:"absolute",top:0,left:0,right:0,zIndex:10,p:2,display:"flex",alignItems:"center",gap:2,borderRadius:0},children:[e.jsx(K,{onClick:()=>R("/marketing/automations"),size:"small",children:e.jsx(Q,{})}),e.jsx(o,{variant:"h6",sx:{fontWeight:600},children:l?.name||"Automation"})]}),e.jsxs(i,{sx:{height:"100%",width:"100%",pt:8,display:"flex"},children:[e.jsx(i,{sx:{flex:1,height:"100%"},children:e.jsxs(J,{nodes:a,edges:c,onNodesChange:D,onEdgesChange:T,onNodeClick:(t,s)=>{t.stopPropagation(),N(s.id)},onPaneClick:()=>N(null),nodeTypes:q,fitView:!0,attributionPosition:"bottom-left",children:[e.jsx(L,{variant:"dots",gap:20,size:1,color:"#e0e0e0"}),e.jsx(H,{}),e.jsx(_,{})]})}),e.jsx(I,{elevation:2,sx:{width:320,height:"100%",borderRadius:0,borderLeft:"1px solid #e0e0e0",display:"flex",flexDirection:"column"},children:n&&a.find(t=>t.id===n&&t.type==="condition")?e.jsxs(e.Fragment,{children:[e.jsx(i,{sx:{p:2,borderBottom:"1px solid #e0e0e0",display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(G,{sx:{color:"text.secondary",fontSize:20}}),e.jsx(o,{variant:"h6",sx:{fontWeight:600},children:"Condition"})]})}),e.jsx(i,{sx:{p:2,borderBottom:"1px solid #e0e0e0"},children:e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:1},children:[e.jsx(o,{variant:"body2",color:"text.secondary",children:"Take different actions based on the conditions you set"}),e.jsx(U,{sx:{color:"text.secondary",fontSize:16,mt:.25}})]})}),e.jsxs(i,{sx:{flex:1,overflow:"auto",p:2},children:[e.jsx(o,{variant:"h6",sx:{fontWeight:600,mb:2},children:"IF"}),e.jsxs(X,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Y,{id:"operator-label",children:"Operator"}),e.jsxs(Z,{labelId:"operator-label",label:"Operator",value:a.find(t=>t.id===n)?.data?.operator||"",disabled:!0,children:[e.jsx(r,{value:"equal",children:"Equal to"}),e.jsx(r,{value:"not-equal",children:"Not equal to"}),e.jsx(r,{value:"greater-than",children:"Greater than"}),e.jsx(r,{value:"greater-than-or-equal",children:"Greater than or equal to"}),e.jsx(r,{value:"less-than",children:"Less than"}),e.jsx(r,{value:"less-than-or-equal",children:"Less than or equal to"}),e.jsx(r,{value:"is-at-least-one-of",children:"Is at least one of"}),e.jsx(r,{value:"is-not-any-of",children:"Is not any of"}),e.jsx(r,{value:"does-not-exist",children:"Does not exist"}),e.jsx(r,{value:"exists",children:"Exists"})]})]}),e.jsxs(i,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:2,backgroundColor:"#fafafa"},children:[e.jsx(o,{variant:"body2",color:"text.secondary",children:"Variable"}),e.jsx(o,{variant:"body1",sx:{fontWeight:500},children:a.find(t=>t.id===n)?.data?.variable||"-"}),e.jsx(o,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"Value"}),e.jsx(o,{variant:"body1",sx:{fontWeight:500},children:a.find(t=>t.id===n)?.data?.value||"-"})]})]})]}):n&&a.find(t=>t.id===n&&t.type==="action")?e.jsx(e.Fragment,{children:e.jsxs(i,{sx:{p:2,borderBottom:"1px solid #e0e0e0"},children:[e.jsx(o,{variant:"h6",sx:{fontWeight:600},children:"Action"}),e.jsx(o,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:a.find(t=>t.id===n)?.data?.label||"Action"})]})}):n&&a.find(t=>t.id===n&&t.type==="trigger")?e.jsx(e.Fragment,{children:e.jsxs(i,{sx:{p:2,borderBottom:"1px solid #e0e0e0"},children:[e.jsx(o,{variant:"h6",sx:{fontWeight:600},children:"Trigger"}),e.jsx(o,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:a.find(t=>t.id===n)?.data?.label||"Trigger"})]})}):e.jsx(i,{sx:{p:2},children:e.jsx(o,{variant:"body2",color:"text.secondary",children:"Select a node to view details."})})})]}),E&&e.jsx(i,{sx:{position:"absolute",bottom:80,right:24},children:e.jsxs(I,{elevation:3,sx:{p:1.5,borderRadius:2,display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(o,{variant:"body2",children:"Unsaved changes"}),e.jsx(ee,{variant:"contained",size:"small",onClick:async()=>{if(!l?._id)return;const t={...l.flowData||{},nodes:a,edges:c};try{await F(l._id,{flowData:t}),x.current={nodes:b(a),edges:y(c)},h(!1)}catch{}},children:"Update"})]})})]})};export{ue as default};
