import{p as W,u as _,T as H,U as J,b as Q,r as n,O as i,j as t,g as V,M as X,F as Y}from"./index-C7S6h9OR.js";import{G as Z}from"./GridBackgroundWrapper-Du1VLjut.js";import{F as ee}from"./ArrowLeftIcon-C1qOxHB_.js";const ae=()=>{const{roleId:u}=W(),F=_(),{permissions:p,loading:y,error:b,fetchAll:A}=H(),{roles:C,fetchByStoreId:B,update:E}=J(),{activeStoreId:j}=Q(),l=n.useMemo(()=>C.find(e=>e._id===u),[C,u]);n.useEffect(()=>{p.length===0&&!y&&A().catch(()=>{})},[]),n.useEffect(()=>{!l&&j&&B(j).catch(()=>{})},[j,l]);const[f,z]=n.useState(""),[P,T]=n.useState(new Set),[d,N]=n.useState(new Set),[m,L]=n.useState(""),[x,R]=n.useState(""),[K,M]=n.useState(!1);n.useEffect(()=>{l&&(L(l.name||""),R(l.description||""),N(new Set(l.permissions||[])))},[l]);const g=n.useMemo(()=>{const e=new Map;p.forEach(s=>{e.set(s.key,{key:s.key,name:s.name,isLeaf:s.isLeaf??!0,parentKey:s.parentKey??null,order:s.order,resource:s.resource,children:[]})});const a=[];e.forEach(s=>{s.parentKey&&e.has(s.parentKey)?e.get(s.parentKey).children.push(s):a.push(s)});const r=s=>{s.sort((c,o)=>(c.order??0)-(o.order??0)||c.name.localeCompare(o.name)),s.forEach(c=>r(c.children))};return r(a),a},[p]),v=n.useMemo(()=>{const e=[],a=r=>{r.isLeaf||r.children.length===0?e.push(r.key):r.children.forEach(a)};return g.forEach(a),e},[g]);n.useEffect(()=>{if(!v.length)return;const e=new Set(v);N(a=>{const r=new Set;return a.forEach(s=>{e.has(s)&&r.add(s)}),r})},[v]);const $=e=>{T(a=>{const r=new Set(a);return r.has(e)?r.delete(e):r.add(e),r})},w=e=>e.isLeaf||e.children.length===0?[e.key]:e.children.flatMap(w),I=e=>{const a=w(e),r=a.filter(s=>d.has(s));return{total:a.length,selected:r.length,checked:r.length===a.length&&a.length>0,indeterminate:r.length>0&&r.length<a.length}},G=e=>{const a=w(e);N(r=>{const s=new Set(r);return a.every(o=>s.has(o))?a.forEach(o=>s.delete(o)):a.forEach(o=>s.add(o)),s})},q=n.useMemo(()=>{const e=g;if(!f.trim())return e;const a=f.toLowerCase(),r=s=>{const c=s.name.toLowerCase().includes(a)||s.key.toLowerCase().includes(a),o=s.children.map(r).filter(h=>!!h);return c||o.length>0?{...s,children:o}:null};return e.map(r).filter(s=>!!s)},[g,f]),S=n.useMemo(()=>Array.from(d).sort(),[d]),k=n.useMemo(()=>l?[...l.permissions||[]].sort():[],[l]),O=n.useMemo(()=>{if(!l)return!1;const e=m.trim()!==(l.name||""),a=x.trim()!==(l.description||""),r=S.length!==k.length||S.some((s,c)=>s!==k[c]);return e||a||r},[l,m,x,k,S]),U=n.useCallback(async()=>{if(!l||!u)return;const e=m.trim(),a=x.trim();if(!e){i.dismiss(),i.error("Role name is required");return}if(d.size===0){i.dismiss(),i.error("Select at least one permission");return}try{M(!0),i.dismiss(),await E(u,{name:e,description:a,permissions:Array.from(d)}),i.dismiss(),i.success("Role updated")}catch(r){const s=r?.response?.data?.message||r?.message||"Failed to update role";i.dismiss(),i.error(s)}finally{M(!1)}},[l,u,m,x,d,E]),D=(e,a=0)=>{const r=e.children.length>0,s=I(e),c=P.has(e.key)||!r,o=a*1.5;return t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center py-1.5",style:{paddingLeft:`${o}rem`},children:[r?t.jsx("button",{onClick:()=>$(e.key),className:"p-0.5 text-gray-600 hover:text-gray-700 mr-1",children:c?t.jsx(X,{className:"w-4 h-4"}):t.jsx(Y,{className:"w-4 h-4"})}):t.jsx("div",{className:"w-6 mr-1"}),t.jsx("input",{type:"checkbox",ref:h=>{h&&(h.indeterminate=!s.checked&&s.indeterminate)},checked:s.checked,onChange:()=>G(e),className:"w-4 h-4 text-gray-900 focus:ring-gray-400 mr-2"}),t.jsx("span",{className:"text-sm text-gray-900",children:e.name}),r&&t.jsxs("span",{className:"text-xs text-gray-600 ml-auto mr-2",children:[s.selected,"/",s.total]})]}),r&&t.jsx("div",{className:c?"block":"hidden",children:e.children.map(h=>D(h,a+1))})]},e.key)};return t.jsx(Z,{children:t.jsxs("div",{className:"max-w-7xl mx-auto py-8 px-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h1",{className:"text-xl font-medium text-gray-900",children:m||"Role"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>F("/settings/users/roles"),className:"px-3 py-1.5 text-sm border border-gray-200 text-gray-700 hover:bg-gray-50 transition-colors flex items-center gap-1.5",children:[t.jsx(ee,{className:"w-4 h-4"}),"Back to roles"]}),t.jsx("button",{disabled:!O||d.size===0||!l||K,onClick:U,className:"px-3 py-1.5 text-sm text-white bg-gray-900 hover:bg-gray-800 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed",children:K?"Saving…":"Save"})]})]}),t.jsx("div",{className:"border border-gray-200 bg-white p-4 mb-4",children:t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Name"}),t.jsx("input",{type:"text",value:m,onChange:e=>L(e.target.value),className:"w-full border border-gray-200 px-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Description"}),t.jsx("textarea",{rows:2,value:x,onChange:e=>R(e.target.value),className:"w-full border border-gray-200 px-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 resize-y"})]})]})}),t.jsxs("div",{className:"border border-gray-200 bg-white p-4",children:[t.jsx("h2",{className:"text-base font-medium text-gray-900 mb-1",children:"Permissions"}),t.jsx("p",{className:"text-xs text-gray-600 mb-3",children:"Selected permissions for this role."}),y&&t.jsxs("div",{className:"flex items-center gap-2 text-gray-600",children:[t.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-gray-900 rounded-full animate-spin"}),t.jsx("span",{className:"text-sm",children:"Loading permissions…"})]}),b&&t.jsx("p",{className:"text-sm text-red-600",children:b}),!y&&!b&&t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsxs("div",{className:"relative",children:[t.jsx(V,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-600"}),t.jsx("input",{type:"text",placeholder:"Search",value:f,onChange:e=>z(e.target.value),className:"w-full border border-gray-200 bg-gray-50 pl-10 pr-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400"})]}),t.jsx("div",{children:q.map(e=>D(e))})]})]})]})})};export{ae as default};
