import{a8 as et,u as tt,b as st,a9 as ot,r as E,j as i}from"./index-C7S6h9OR.js";import nt from"./grapes-e2OmM4qI.js";/* empty css                   */const Se='<section style="padding: 60px 20px; min-height: 400px; background: #ffffff; position: relative; border: 2px dashed #d1d5db; border-radius: 4px; max-width: 1200px; margin: 60px auto;"><div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; gap: 12px; color: #6b7280; font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;"><div style="display: flex; gap: 12px; align-items: center;"><span style="width: 40px; height: 40px; border-radius: 50%; background: #1e1e1e; display: inline-flex; align-items: center; justify-content: center; color: #fff; font-size: 18px;">+</span><span style="width: 40px; height: 40px; border-radius: 50%; background: #1e1e1e; display: inline-flex; align-items: center; justify-content: center; color: #fff; font-size: 18px;">üìÅ</span></div><p style="margin: 0; font-size: 14px; font-weight: 500;">Start building your page</p><p style="margin: 0; font-size: 12px; opacity: 0.7;">Drag blocks from the sidebar or click to add content</p></div></section>',xe={Header:["header",".header","#header","[class*='header']","[id*='header']","nav",".navbar",".navigation"],"Hero section":[".hero-section",".hero","[class*='hero']","[id*='hero']",".banner","[class*='banner']",".jumbotron","[class*='jumbotron']"],"Logo banner":[".logo-banner","[class*='logo-banner']","[class*='logo']",".banner","[class*='banner']"],"Collection list: Grid":[".collection-grid","[class*='collection'][class*='grid']",".product-grid","[class*='product-grid']",".grid","[class*='collection-list']"],"Product highlight":[".product-highlight","[class*='product-highlight']",".featured-product","[class*='featured-product']",".highlight"],"Product card":[".product-card","[class*='product-card']","[class*='productCard']",".product-item","[class*='product-item']","[class*='productItem']",".product","[class*='product']:not([class*='product-grid']):not([class*='product-list'])","[data-product]",".card","[class*='card']","article","[role='article']",".item","[class*='item']"],"Featured collection":[".featured-collection","[class*='featured-collection']",".featured-products","[class*='featured-products']"],"Collection list: Carousel":[".collection-carousel","[class*='carousel']","[class*='slider']",".product-carousel","[class*='collection'][class*='carousel']"],Marquee:[".marquee","[class*='marquee']",".scrolling-text","[class*='scrolling']"],Footer:["footer",".footer","#footer","[class*='footer']","[id*='footer']"],Logo:[".logo","[class*='logo']","[id*='logo']","img[alt*='logo' i]","img[src*='logo' i]"]},ht=()=>{const[ge]=et(),ze=tt(),{activeStoreId:ue}=st(),{createTheme:ie,updateTheme:Ce}=ot(),le=E.useRef(null),A=E.useRef(null),z=E.useRef(""),Fe=E.useRef([]),[We,Z]=E.useState(!0),[ke,Y]=E.useState(null),[O,Re]=E.useState(""),[U,fe]=E.useState("desktop"),[K,se]=E.useState(null),[Q,oe]=E.useState(!1),[He,ne]=E.useState(!0),[rt,Be]=E.useState(!1),[at,qe]=E.useState(!1),[ce,ye]=E.useState(!1),[we,je]=E.useState(!1),[Oe,be]=E.useState(!1),[de,Ee]=E.useState(""),[X,Ue]=E.useState({header:!0,template:!0,footer:!0}),[Te,Pe]=E.useState([{id:"page-1",name:"Home",html:Se,css:""}]),re=E.useRef([{id:"page-1",name:"Home",html:Se,css:""}]),[_,Me]=E.useState("page-1"),D=ge.get("id")||ge.get("themeId")||"",ae=ge.get("type")||"",_e=E.useCallback(async(e,s,o,n)=>{const r=[];try{const d=new DOMParser,f=d.parseFromString(s,"text/html"),p=new Set;f.querySelectorAll("a[href]").forEach(a=>{const g=a.getAttribute("href");if(!g||/^(?:https?:|mailto:|tel:|javascript:|#|\/\/)/i.test(g))return;const v=g.split("?")[0].split("#")[0].trim();if(!v||v==="index.html"||v==="/")return;const y=v.replace(/^\/+/,"");y&&!p.has(y)&&p.add(y)}),console.log(`üîç Discovered ${p.size} potential pages from hyperlinks:`,Array.from(p));const c=a=>{if(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("//"))return a.startsWith("//")?"https:"+a:a;const g=e.endsWith("/")?e:`${e}/`;if(a.startsWith("/"))return`${g}${a.replace(/^\/+/,"")}`;try{return new URL(a,g).href}catch{return g+a}},w=async a=>{try{const g=[];a.toLowerCase().endsWith(".html")?g.push(`${e}/${a}?v=${Date.now()}`):(g.push(`${e}/${a}/index.html?v=${Date.now()}`),g.push(`${e}/${a}.html?v=${Date.now()}`));let v=null;for(const T of g)try{const S=await fetch(T,{credentials:"include",headers:n()});if(S.ok){v=await S.text();break}}catch(S){console.warn(`Failed to fetch page from ${T}:`,S)}if(!v)return console.warn(`Could not fetch page: ${a}`),null;const y=d.parseFromString(v,"text/html"),x=await(async T=>{const S=[],W=Array.from(T.querySelectorAll('link[rel="stylesheet"]')).map(async $=>{const R=$.getAttribute("href");if(!R)return"";const L=c(R);try{const F=await fetch(L,{credentials:"include",headers:n()});return F.ok?await F.text()||"":`@import url('${L}');`}catch{return`@import url('${L}');`}}),B=await Promise.all(W);S.push(...B.filter($=>$.trim()));const G=Array.from(T.querySelectorAll("style")).map($=>$.textContent||"").filter($=>$.trim());return S.push(...G),S.join(`

`).trim()})(y),l=o?x?`${o}

/* Page-specific styles */
${x}`:o:x,m=y.body?y.body.innerHTML:v,u=a.replace(/\.html$/i,"").replace(/\/index$/i,"").replace(/\//g,"-").replace(/[^a-z0-9-]/gi,"-").toLowerCase()||`page-${Date.now()}`,k=(a.replace(/\.html$/i,"").replace(/\/index$/i,"").split("/").pop()||"Page").split("-").map(T=>T.charAt(0).toUpperCase()+T.slice(1)).join(" ");return{id:u,name:k,html:m||Se,css:l||""}}catch(g){return console.error(`Error fetching page ${a}:`,g),null}},t=Array.from(p).map(a=>w(a));(await Promise.all(t)).forEach(a=>{a&&r.push(a)}),console.log(`‚úÖ Successfully discovered and fetched ${r.length} additional pages`)}catch(d){console.error("Error discovering pages:",d)}return r},[]),Ne=E.useCallback(async e=>{try{const s="https://backend.ziplofy.com/api",o=`?v=${Date.now()}`,n=()=>{try{const j=localStorage.getItem("accessToken")||sessionStorage.getItem("accessToken");if(!j)return null;const P=j.split(".");if(P.length<2)return null;const b=JSON.parse(atob(P[1].replace(/-/g,"+").replace(/_/g,"/")));return String(b.uid||b.userId||b.id||"")}catch{return null}},r=()=>{const j={},P=localStorage.getItem("accessToken")||sessionStorage.getItem("accessToken")||localStorage.getItem("token")||sessionStorage.getItem("token");return P&&(j.Authorization=`Bearer ${P}`),j},d=n(),f=D&&/^[0-9a-fA-F]{24}$/.test(D);let p="";if(ae==="installed"){const j=ue?`${s}/themes/installed/${ue}/${D}/unzippedTheme`:d?`${s}/themes/installed/${d}/${D}/unzippedTheme`:null;if(j)p=`${j}/index.html${o}`,console.log("‚úì Using installed theme:",p);else throw new Error("Store ID or User ID required for installed themes")}else f?(p=`${s}/custom-themes/${D}/files/index.html${o}`,console.log("‚úì Using custom theme:",p)):(p=`${s}/themes/preview/${D}${o}`,console.log("‚úì Using preview theme:",p));console.log("Fetching theme from:",p);const c=await fetch(p,{credentials:"include",headers:r()});if(!c.ok){const j=await c.text().catch(()=>"Unknown error");let P=`Failed to load theme HTML: ${c.status} ${c.statusText}. ${j}`;if(c.status===404)try{JSON.parse(j).error?.includes("not found")&&(P=`Theme not found. The theme with ID "${D}" does not exist in the database. Please create a new theme or use an existing theme ID.`)}catch{}else c.status===401&&(P="Authentication failed. Please log in again and try loading the theme.");throw new Error(P)}let w=await c.text();const t=p.substring(0,p.lastIndexOf("/")+1),h=/<style[^>]*>([\s\S]*?)<\/style>/gi;let a="",g;for(;(g=h.exec(w))!==null;)a+=g[1]+`
`;const v=/<link[^>]*rel\s*=\s*["']stylesheet["'][^>]*>/gi,y=[];let C;for(;(C=v.exec(w))!==null;){const P=C[0].match(/href\s*=\s*["']([^"']+)["']/i);if(P&&P[1]){let b=P[1];if(b.startsWith("./")||b.startsWith("../")||!b.startsWith("http"))if(b.startsWith("./"))b=t+b.substring(2);else if(b.startsWith("../")){const H=t.split("/").filter(I=>I),Le=b.split("/").filter(I=>I);for(const I of Le)I===".."?H.pop():I!=="."&&H.push(I);b=H.join("/"),b.startsWith("http")||(b=t.replace(/\/[^\/]*$/,"/")+b)}else b=t+b;y.push(b)}}Fe.current=y;const x=j=>{try{const b=new URL(j).hostname.toLowerCase();return b.includes("googleapis.com")||b.includes("cdnjs.cloudflare.com")||b.includes("stackpath.bootstrapcdn.com")||b.includes("cdn.jsdelivr.net")||b.includes("unpkg.com")||b.includes("fonts.googleapis.com")||b.includes("fonts.gstatic.com")}catch{return!1}},l=j=>j.startsWith("http://")||j.startsWith("https://")||j.startsWith("//")?j.startsWith("//")?"https:"+j:j:t+j.replace(/^\.\//,"");let m=a;const u=y.map(async j=>{const P=l(j);if(x(P))return console.log(`Using @import for external CDN: ${P}`),`@import url('${P}');`;try{const b=await fetch(P,{credentials:"include",headers:r()});if(b.ok){const H=await b.text();return console.log("‚úì Fetched external CSS:",P,H.length,"chars"),H||""}else return console.warn(`Failed to fetch CSS from ${P}:`,b.status),`@import url('${P}');`}catch(b){return console.warn(`Error fetching CSS from ${P}, using @import:`,b),`@import url('${P}');`}}),k=(await Promise.all(u)).filter(j=>j.trim()).join(`

`);k&&(m+=`

`+k),z.current=m,console.log("‚úì Stored original theme CSS:",m.length,"chars"),w=w.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,""),w=w.replace(/<link[^>]*rel\s*=\s*["']stylesheet["'][^>]*>/gi,"");const T=w.match(/<body[^>]*>([\s\S]*)<\/body>/i),S=T?T[1]:w,W=w.match(/<html[^>]*>([\s\S]*)<\/html>/i),B=S||(W?W[1]:w),G=await _e(t,w,m,r),R=[{id:"page-1",name:"Home",html:B,css:m},...G];Pe(R),re.current=R,Me("page-1"),console.log(`‚úÖ Loaded ${R.length} pages:`,R.map(j=>({id:j.id,name:j.name}))),e.setComponents(B);const L=()=>{try{const j=e.Canvas;if(!j)return console.warn("Canvas not available yet"),!1;const P=j.getFrameEl();if(!P||!P.contentDocument)return console.warn("Frame or frame document not available"),!1;const b=P.contentDocument,H=b.head||b.getElementsByTagName("head")[0];if(!H)return console.warn("Head element not found"),!1;if(H.querySelectorAll("#ziplofy-theme-styles, style[data-ziplofy-theme], link[data-ziplofy-theme]").forEach(I=>I.remove()),a.trim()){const I=b.createElement("style");I.id="ziplofy-theme-styles",I.setAttribute("data-ziplofy-theme","true"),I.textContent=a,H.appendChild(I),console.log("‚úì Injected inline CSS")}if(y.forEach((I,Ae)=>{const M=b.createElement("link");M.rel="stylesheet",M.href=I,M.setAttribute("data-ziplofy-theme","true"),M.crossOrigin="anonymous",M.onerror=()=>{console.warn(`Failed to load stylesheet: ${I}`)},M.onload=()=>{console.log(`‚úì Loaded stylesheet: ${I}`)},H.appendChild(M)}),a){const I=a.matchAll(/@import\s+(?:url\()?['"]?([^'")]+)['"]?\)?/gi);for(const Ae of I){let M=Ae[1];if(!M.startsWith("http")&&!M.startsWith("//"))if(M.startsWith("./")||M.startsWith("../")){const q=t.split("/").filter(J=>J),Xe=M.split("/").filter(J=>J);for(const J of Xe)J===".."?q.pop():J!=="."&&q.push(J);M=q.join("/"),M.startsWith("http")||(M=t.replace(/\/[^\/]*$/,"/")+M)}else M=t+M;if(!Array.from(H.querySelectorAll('link[rel="stylesheet"]')).find(q=>q.href===M||q.href.endsWith(M))&&M){const q=b.createElement("link");q.rel="stylesheet",q.href=M,q.setAttribute("data-ziplofy-theme","true"),q.crossOrigin="anonymous",H.appendChild(q),console.log(`‚úì Added @import stylesheet: ${M}`)}}}return!0}catch(j){return console.error("Error injecting CSS:",j),!1}};let F=0;const te=15,V=()=>{if(L()){console.log("‚úì CSS injection successful");return}if(F++,F<te)setTimeout(V,200);else if(console.error("Failed to inject CSS after multiple retries"),a.trim())try{e.setStyle(a),console.log("‚úì Applied CSS via editor.setStyle fallback")}catch(j){console.error("Failed to set CSS via editor.setStyle:",j)}};setTimeout(V,100),setTimeout(V,300),setTimeout(V,500),setTimeout(V,800),setTimeout(V,1200),setTimeout(V,2e3),console.log("‚úì Theme loaded into GrapesJS editor")}catch(s){throw console.error("Failed to load theme:",s),Y(s?.message||"Failed to load theme. Please check the console for details."),s}},[D,ae,ue]);E.useEffect(()=>{if(!D){Y("No theme ID provided. Please select a theme to edit."),Z(!1);return}return(async()=>{let s=0;for(;!le.current&&s<10;)await new Promise(o=>setTimeout(o,100)),s++;if(!le.current){Y("Editor container not found"),Z(!1);return}try{Z(!0),Y(null);const o="https://backend.ziplofy.com/api",n=()=>{const t={},h=localStorage.getItem("accessToken")||sessionStorage.getItem("accessToken")||localStorage.getItem("token")||sessionStorage.getItem("token");return h&&(t.Authorization=`Bearer ${h}`),t};try{const t=D&&/^[0-9a-fA-F]{24}$/.test(D);let h="";t&&ae!=="installed"?h=`${o}/custom-themes/${D}`:h=`${o}/themes/${D}`;const a=await fetch(h,{credentials:"include",headers:n()});if(a.ok){const g=await a.json(),v=g?.data?.name||g?.name||"Theme";Re(v)}}catch{}let r=document.getElementById("style-panel-wrapper");r||(r=document.createElement("div"),r.id="style-panel-wrapper",r.className="style-panel-content-wrapper",r.style.display="none",document.body.appendChild(r),console.log("‚úì Created style-panel-wrapper element for StyleManager"));const d=nt.init({container:le.current,height:"100%",width:"100%",fromElement:!1,storageManager:!1,deviceManager:{devices:[{name:"Desktop",width:""},{name:"Tablet",width:"768px",widthMedia:"992px"},{name:"Mobile",width:"320px",widthMedia:"768px"}]},selectorManager:{componentFirst:!0},styleManager:{appendTo:"#style-panel-wrapper",sectors:[{name:"Layout",open:!0,buildProps:["width","height","min-width","min-height","max-width","max-height","padding","margin","display","position","top","right","bottom","left","z-index"]},{name:"Typography",open:!0,buildProps:["font-family","font-size","font-weight","font-style","text-decoration","text-align","color","line-height","letter-spacing"]},{name:"Background",open:!0,buildProps:["background-color","background-image","background-repeat","background-position","background-size"]},{name:"Border",open:!0,buildProps:["border","border-radius","box-shadow"]},{name:"Extra",open:!0,buildProps:["opacity","cursor","overflow","transition"]}],showComputed:!0},panels:{defaults:[]},canvas:{styles:[]}});A.current=d,setTimeout(()=>{if(d&&d.setDevice){const h={desktop:"Desktop",tablet:"Tablet",mobile:"Mobile"}[U]||U;d.setDevice(h),console.log("‚úì Initial device set:",h),setTimeout(()=>{const a=d.Canvas;if(a){const g=a.getCanvasEl?a.getCanvasEl():document.querySelector(".gjs-cv-canvas"),v=a.getFrameEl();g&&(g.style.cssText=`
                    display: flex !important;
                    justify-content: center !important;
                    align-items: flex-start !important;
                    width: 100% !important;
                    height: 100% !important;
                    margin: 0 !important;
                    padding: 24px !important;
                    left: auto !important;
                    right: auto !important;
                  `),v&&(v.style.cssText=`
                    margin: 0 auto !important;
                    display: block !important;
                    left: auto !important;
                    right: auto !important;
                  `)}},200)}},100),d.on("change:device",()=>{setTimeout(()=>{const t=d.Canvas;if(t){const h=t.getCanvasEl?t.getCanvasEl():document.querySelector(".gjs-cv-canvas"),a=t.getFrameEl();h&&(h.style.cssText=`
                  display: flex !important;
                  justify-content: center !important;
                  align-items: flex-start !important;
                  width: 100% !important;
                  height: 100% !important;
                  margin: 0 !important;
                  padding: 24px !important;
                  left: auto !important;
                  right: auto !important;
                `),a&&(a.style.cssText=`
                  margin: 0 auto !important;
                  display: block !important;
                  left: auto !important;
                  right: auto !important;
                `)}},100)}),setTimeout(()=>{const t=document.querySelector("#style-panel-wrapper");if(t&&d.StyleManager)try{const h=d.StyleManager;h.setContainer?h.setContainer(t):h.container&&(h.container.el=t,h.container=t),console.log("‚úì StyleManager container configured:",{wrapperExists:!!t,wrapperId:t.id,hasSetContainer:typeof h.setContainer=="function",hasContainer:!!h.container})}catch(h){console.warn("Could not update StyleManager container:",h)}if(d.StyleManager)try{const h=d.StyleManager.getSectors();console.log("‚úì StyleManager available:",{sectors:h?.length||0,sectorNames:h?.map(a=>a.getName?a.getName():a.name||"Unknown")||[],wrapperExists:!!t})}catch(h){console.warn("StyleManager initialization check:",h)}},500),d.on("style:custom",()=>{});const f=()=>{const t=d.UndoManager;t&&(Be(t.hasUndo()),qe(t.hasRedo()))};d.on("update",f),d.on("component:update",f),d.on("style:update",f);const p=t=>{try{t&&t.set&&(t.set("draggable",!1),t.set("droppable",!1),t.set("resizable",!1))}catch{}};d.on("component:add",t=>{p(t),t.components&&t.components().forEach(h=>{p(h)})}),d.on("component:drag",t=>(t&&t.stop&&t.stop(),t&&t.preventDefault&&t.preventDefault(),!1)),d.on("component:drag:start",t=>(t&&t.stop&&t.stop(),t&&t.preventDefault&&t.preventDefault(),!1)),setTimeout(()=>{const t=d.Canvas;if(t){const h=t.getFrameEl();if(h&&h.contentDocument){const a=h.contentDocument.createElement("style");a.setAttribute("data-ziplofy-disable-drag","true"),a.textContent=`
                * {
                  -webkit-user-drag: none !important;
                  -moz-user-drag: none !important;
                  -ms-user-drag: none !important;
                  user-drag: none !important;
                }
                .gjs-selected {
                  cursor: default !important;
                }
                .gjs-dashed * {
                  cursor: default !important;
                }
              `,h.contentDocument.head.appendChild(a)}}},500),setTimeout(()=>{try{const t=d.getWrapper();if(t){const h=[],a=g=>{g&&(h.push(g),(g.components?g.components():[]).forEach(y=>a(y)))};a(t),h.forEach(g=>{p(g)}),console.log(`‚úì Disabled drag on ${h.length} components`)}}catch(t){console.warn("Error disabling drag on components:",t)}},1e3);const w=t=>{if(!t)return null;const h=t.getEl();if(!h)return null;const a=h.tagName?.toLowerCase(),g=typeof h.className=="string"?h.className:h.className?.baseVal||"",v=h.id||"",y=g.toLowerCase().split(/\s+/).filter(C=>C);for(const[C,x]of Object.entries(xe))for(const l of x)try{const m=l.toLowerCase().trim();if(m===a)return C;if(m.startsWith(".")){const k=m.substring(1).toLowerCase();if(y.includes(k)||g.toLowerCase().includes(k))return C}if(m.startsWith("#")){const k=m.substring(1).toLowerCase();if(v.toLowerCase()===k)return C}if(m.includes("["))try{if(h.matches&&h.matches(l))return C}catch{}let u=h,N=0;for(;u&&N<5;)try{if(u.matches&&u.matches(l))return C;const k=u.tagName?.toLowerCase(),T=(u.className||"").toString().toLowerCase(),S=(u.id||"").toLowerCase();if(m===k||m.startsWith(".")&&T.includes(m.substring(1))||m.startsWith("#")&&S===m.substring(1))return C;u=u.parentElement,N++}catch{break}}catch{}return a==="header"||y.some(C=>C.includes("header"))?"Header":a==="footer"||y.some(C=>C.includes("footer"))?"Footer":a==="nav"||y.some(C=>C.includes("nav"))?"Header":y.some(C=>C.includes("hero"))?"Hero section":y.some(C=>C.includes("product")&&C.includes("card"))?"Product card":y.some(C=>C.includes("product")&&C.includes("highlight"))?"Product highlight":null};d.on("component:selected",t=>{console.log("‚úì Component selected:",t);const a=w(t)||t.getName()||t.get("tagName")||"Selected Element";se(a),ne(!1),oe(!0);const g=()=>{const v=document.querySelector(".style-editor-panel"),y=v?.querySelector("#style-panel-wrapper"),C=document.getElementById("style-panel-wrapper");if(!y){console.warn("‚ö†Ô∏è React wrapper not found, retrying..."),setTimeout(g,100);return}if(!d.StyleManager){console.error("‚ùå StyleManager not available");return}v&&(v.style.display="flex",v.style.visibility="visible",v.style.opacity="1"),y.style.display="block",y.style.visibility="visible",y.style.opacity="1",y.style.width="100%",y.style.height="100%";const x=d.StyleManager;if(x.container?x.container.el=y:x.container={el:y},x.config&&(x.config.appendTo=y),x.view&&x.view.container&&(x.view.container=y),C){const m=C.querySelector(".gjs-sm");m&&m.parentElement===C&&(y.innerHTML="",y.appendChild(m),console.log("‚úì Moved StyleManager content to React panel"))}if(d.select(t),x.setTarget)try{x.setTarget(t),console.log("‚úì Set StyleManager target to component")}catch{console.warn("setTarget not available, using default behavior")}y.innerHTML="";try{x.render(),console.log("‚úì StyleManager.render() called")}catch(m){if(console.error("‚ùå Error rendering StyleManager:",m),x.view&&x.view.render)try{x.view.render(),x.view.el&&x.view.el.parentElement!==y&&y.appendChild(x.view.el),console.log("‚úì StyleManager view rendered")}catch(u){console.error("‚ùå Error with alternative render:",u)}}const l=(m=0)=>{if(!y.querySelector(".gjs-sm")&&C){const k=C.querySelector(".gjs-sm");k&&(y.innerHTML="",y.appendChild(k),console.log("‚úì Moved StyleManager from static wrapper"))}const N=y.querySelector(".gjs-sm");if(N){const k=N.querySelectorAll(".gjs-sm-sector");k.length>0?(k.forEach(T=>{const S=T;S.classList.remove("gjs-sm-sector--closed"),S.classList.add("gjs-sm-sector--open");const W=S.querySelector(".gjs-sm-sector-content");W&&(W.style.cssText="display: block !important; visibility: visible !important; opacity: 1 !important; max-height: none !important;"),S.querySelectorAll(".gjs-sm-properties").forEach(G=>{G.style.cssText="display: block !important; visibility: visible !important; opacity: 1 !important;"})}),console.log("‚úì StyleManager ready with",k.length,"sectors")):m<3?setTimeout(()=>l(m+1),100):(console.warn("‚ö†Ô∏è No sectors found after multiple attempts"),setTimeout(()=>{y.innerHTML="",x.render(),setTimeout(()=>l(0),200)},200))}else m<3?setTimeout(()=>l(m+1),100):console.error("‚ùå StyleManager element not found after multiple attempts")};setTimeout(()=>l(0),100),setTimeout(()=>l(0),300),setTimeout(()=>l(0),500)};requestAnimationFrame(()=>{setTimeout(g,150)})}),d.on("component:deselected",()=>{console.log("‚úì Component deselected"),oe(!1),ne(!0),se(null)}),d.on("canvas:click",t=>{console.log("Canvas clicked:",t)}),d.on("component:update",()=>{if(d.getSelected()&&Q&&(console.log("Component updated, ensuring StyleManager is rendered"),document.querySelector("#style-panel-wrapper")&&d.StyleManager))try{d.StyleManager.render()}catch(a){console.warn("Error re-rendering StyleManager on component update:",a)}}),d.on("canvas:frame:load",()=>{console.log("Canvas frame loaded, ensuring CSS is injected"),setTimeout(()=>{const t=d.Canvas;if(t){const h=t.getFrameEl();if(h&&h.contentDocument){const g=h.contentDocument.head;g&&g.querySelectorAll("[data-ziplofy-theme]").length===0&&console.log("No CSS found, triggering re-injection...")}}},100)});try{await Ne(d)}catch(t){console.error("Failed to load theme:",t),Y(t?.message||"Failed to load theme. Please check if the theme exists and you have access to it."),Z(!1);return}Z(!1)}catch(o){console.error("Failed to initialize editor:",o),Y(o?.message||"Failed to initialize editor"),Z(!1)}})(),()=>{A.current&&(A.current.destroy(),A.current=null)}},[D,Ne]);const ee=E.useCallback(()=>{const e=A.current;if(!e||typeof e.getHtml!="function")return;const s=e.getHtml()||"";let o="";e.getCss&&(o=e.getCss()||""),Pe(n=>{const r=n.map(d=>d.id===_?{...d,html:s,css:o}:d);return re.current=r,r})},[_]),Ge=E.useCallback(async e=>{if(e===_)return;const s=A.current;if(!s)return;ee();const o=re.current.find(n=>n.id===e);if(!o){console.warn(`Page ${e} not found`);return}if(Me(e),s.setComponents(o.html),o.css)try{const n=s.Canvas;if(n){const r=n.getFrameEl();if(r&&r.contentDocument){const d=r.contentDocument,f=d.head||d.getElementsByTagName("head")[0];if(f){f.querySelectorAll("#ziplofy-theme-styles, style[data-ziplofy-theme]").forEach(w=>w.remove());const c=d.createElement("style");c.id="ziplofy-theme-styles",c.setAttribute("data-ziplofy-theme","true"),c.textContent=o.css,f.appendChild(c)}}}}catch(n){console.error("Error injecting page CSS:",n)}oe(!1),ne(!0),se(null),console.log(`‚úÖ Switched to page: ${o.name}`)},[_,ee]),ve=e=>{Ue(s=>({...s,[e]:!s[e]}))},he=e=>{const s=A.current;if(!s)return;se(e);const o=xe[e]||[],n=s.getWrapper();if(n)for(const r of o)try{const d=n.find(r)[0];if(d){const f=s.Canvas.getFrameEl();if(f&&f.contentWindow){const p=d.getEl();p&&f.contentWindow.document.contains(p)&&p.scrollIntoView({behavior:"smooth",block:"center"})}break}}catch{continue}},me=(e,s)=>{s.stopPropagation();const o=A.current;if(!o)return;se(e),oe(!0),ne(!1);const n=xe[e]||[],r=o.getWrapper();if(r)for(const d of n)try{const f=r.find(d)[0];if(f){o.select(f);const p=o.Canvas.getFrameEl();if(p&&p.contentWindow){const c=f.getEl();c&&p.contentWindow.document.contains(c)&&c.scrollIntoView({behavior:"smooth",block:"center"})}break}}catch{continue}};E.useEffect(()=>{const e=A.current;if(!e){console.warn("Editor not available for device change");return}const o={desktop:"Desktop",tablet:"Tablet",mobile:"Mobile"}[U]||U;console.log("üîÑ Changing device to:",o);try{e.setDevice&&typeof e.setDevice=="function"?(e.setDevice(o),console.log("‚úì Device set via API:",o),e.refresh&&e.refresh(),e.trigger&&e.trigger("canvas:frame:load"),setTimeout(()=>{const n=e.Canvas;if(!n){console.warn("Canvas not available");return}const r=n.getFrameEl(),d=document.querySelector(".gjs-cv-canvas");d&&(d.style.cssText=`
              display: flex !important;
              justify-content: center !important;
              align-items: flex-start !important;
              width: 100% !important;
              height: 100% !important;
              margin: 0 !important;
              padding: 24px !important;
              left: auto !important;
              right: auto !important;
            `),r&&(r.style.cssText=`
              margin: 0 auto !important;
              display: block !important;
              left: auto !important;
              right: auto !important;
            `);try{const f=e.getDevice?e.getDevice():null;f&&(console.log("‚úì Device verification - Current:",f,"Expected:",o),f!==o&&(console.warn("‚ö†Ô∏è Device mismatch, retrying..."),setTimeout(()=>{e.setDevice(o),e.refresh&&e.refresh()},100)))}catch{console.log("Device verification skipped (getDevice not available)")}},100)):console.error("‚ùå setDevice method not available on editor")}catch(n){console.error("‚ùå Error setting device:",n)}},[U]),E.useEffect(()=>{if(Q){const e=A.current;e&&e.StyleManager&&setTimeout(()=>{const o=document.querySelector("#style-panel-wrapper")||document.querySelector(".style-panel-content-wrapper");if(o)try{const n=e.getSelected();if(!n){console.warn("No component selected, cannot render StyleManager");return}const r=document.querySelector(".style-editor-panel"),f=r?.querySelector("#style-panel-wrapper")||o;r&&(r.style.display="flex",r.style.visibility="visible",r.style.opacity="1"),f.style.display="block",f.style.visibility="visible",f.style.opacity="1",f.style.width="100%",f.style.height="100%";const p=e.StyleManager;if(p.container?p.container.el=f:p.container={el:f},p.config&&(p.config.appendTo=f),p.view&&p.view.container&&(p.view.container=f),e.select(n),p.setTarget)try{p.setTarget(n),console.log("‚úì Set StyleManager target to component")}catch{console.warn("setTarget not available, using default behavior")}f.innerHTML="";try{p.render(),console.log("‚úì StyleManager.render() called in useEffect")}catch(w){if(console.error("‚ùå Error rendering StyleManager:",w),p.view&&p.view.render)try{p.view.render(),p.view.el&&p.view.el.parentElement!==f&&f.appendChild(p.view.el),console.log("‚úì StyleManager view rendered")}catch(t){console.error("‚ùå Error with alternative render:",t)}}const c=(w=0)=>{const t=f.querySelector(".gjs-sm");if(t){const h=t.querySelectorAll(".gjs-sm-sector");h.length>0?(h.forEach(a=>{const g=a;g.classList.remove("gjs-sm-sector--closed"),g.classList.add("gjs-sm-sector--open");const v=g.querySelector(".gjs-sm-sector-content");v&&(v.style.cssText="display: block !important; visibility: visible !important; opacity: 1 !important; max-height: none !important;"),g.querySelectorAll(".gjs-sm-properties").forEach(C=>{C.style.cssText="display: block !important; visibility: visible !important; opacity: 1 !important;"})}),console.log("‚úì StyleManager ready with",h.length,"sectors")):w<3&&setTimeout(()=>c(w+1),100)}else w<3?setTimeout(()=>c(w+1),100):(console.warn("‚ö†Ô∏è StyleManager element not found after multiple attempts, forcing re-render"),f.innerHTML="",p.render(),setTimeout(()=>c(0),200))};setTimeout(()=>c(0),100),setTimeout(()=>c(0),300),setTimeout(()=>c(0),500)}catch(n){console.error("Error rendering StyleManager:",n)}},100)}},[Q]);const Ve=()=>{const e=A.current;e&&e.UndoManager.undo()},Je=()=>{const e=A.current;e&&e.UndoManager.redo()},$e=E.useCallback(e=>new Promise(s=>{const o=document.createElement("canvas");o.width=800,o.height=600;const n=o.getContext("2d");if(!n){const c=`<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600">
          <defs>
            <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
            </linearGradient>
          </defs>
          <rect width="800" height="600" fill="url(#grad)"/>
          <text x="400" y="280" font-family="Arial, sans-serif" font-size="48" font-weight="bold" fill="white" text-anchor="middle">${e}</text>
          <text x="400" y="340" font-family="Arial, sans-serif" font-size="24" fill="rgba(255,255,255,0.9)" text-anchor="middle">Custom Theme</text>
        </svg>`,w=new Blob([c],{type:"image/svg+xml"});s(w);return}const r=n.createLinearGradient(0,0,o.width,o.height);r.addColorStop(0,"#667eea"),r.addColorStop(1,"#764ba2"),n.fillStyle=r,n.fillRect(0,0,o.width,o.height),n.fillStyle="rgba(255, 255, 255, 0.1)",n.beginPath(),n.arc(100,100,60,0,Math.PI*2),n.fill(),n.beginPath(),n.arc(700,500,80,0,Math.PI*2),n.fill(),n.beginPath(),n.arc(650,100,40,0,Math.PI*2),n.fill(),n.fillStyle="#ffffff",n.font="bold 56px Arial, sans-serif",n.textAlign="center",n.textBaseline="middle";const d=700;let f=56,p=n.measureText(e).width;p>d&&(f=d/p*f,n.font=`bold ${f}px Arial, sans-serif`),n.fillText(e,o.width/2,o.height/2-30),n.font="24px Arial, sans-serif",n.fillStyle="rgba(255, 255, 255, 0.9)",n.fillText("Custom Theme",o.width/2,o.height/2+40),o.toBlob(c=>{if(c)s(c);else{const w=`<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600">
            <defs>
              <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
              </linearGradient>
            </defs>
            <rect width="800" height="600" fill="url(#grad)"/>
            <text x="400" y="280" font-family="Arial, sans-serif" font-size="48" font-weight="bold" fill="white" text-anchor="middle">${e}</text>
            <text x="400" y="340" font-family="Arial, sans-serif" font-size="24" fill="rgba(255,255,255,0.9)" text-anchor="middle">Custom Theme</text>
          </svg>`;s(new Blob([w],{type:"image/svg+xml"}))}},"image/png")}),[]),Ie=E.useCallback(e=>{try{return JSON.stringify(e).replace(/</g,"\\u003c").replace(/>/g,"\\u003e").replace(/&/g,"\\u0026")}catch(s){return console.error("Error encoding pages data:",s),"[]"}},[]),pe=E.useCallback((e,s,o)=>{const n=(s||"Ziplofy Theme").replace(/</g,"&lt;").replace(/>/g,"&gt;"),r=Ie(e);return`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>${n}</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #1e1e1e;
      background: #ffffff;
    }
    * {
      box-sizing: border-box;
    }
    .ziplofy-page {
      display: none;
      width: 100%;
      min-height: 100vh;
    }
    .ziplofy-page.active {
      display: block;
    }
    .ziplofy-page > .gjs-wrapper-body,
    .ziplofy-page.gjs-wrapper-body {
      width: 100%;
      min-height: 100vh;
    }
    ${o||""}
  </style>
</head>
<body>
  <div id="ziplofy-page-container"></div>
  <script id="ziplofy-pages-data" type="application/json">${r}<\/script>
  <script>
    (function() {
      try {
        const container = document.getElementById('ziplofy-page-container');
        const dataEl = document.getElementById('ziplofy-pages-data');
        if (!container || !dataEl) return;
        const pagesText = dataEl.textContent || dataEl.innerText || '[]';
        const pages = JSON.parse(pagesText);
        const normalizeId = function(value) {
          if (value === null || value === undefined) return '';
          return String(value).replace(/^#/, '').trim();
        };
        const renderPages = function() {
          container.innerHTML = '';
          pages.forEach(function(page, index) {
            const wrapper = document.createElement('div');
            wrapper.className = 'ziplofy-page gjs-wrapper-body' + (index === 0 ? ' active' : '');
            wrapper.setAttribute('data-page-id', page.id || ('page-' + (index + 1)));
            wrapper.style.display = index === 0 ? 'block' : 'none';
            wrapper.innerHTML = page.html || '';
            container.appendChild(wrapper);
          });
        };
        const showPage = function(pageId) {
          const normalizedRequest = normalizeId(pageId);
          if (!normalizedRequest) return false;
          const pages = document.querySelectorAll('.ziplofy-page');
          let found = false;
          pages.forEach(function(pageEl) {
            const pageIdAttr = pageEl.getAttribute('data-page-id');
            const normalizedPageId = normalizeId(pageIdAttr);
            if (normalizedPageId === normalizedRequest) {
              pageEl.classList.add('active');
              pageEl.style.display = 'block';
              found = true;
            } else {
              pageEl.classList.remove('active');
              pageEl.style.display = 'none';
            }
          });
          return found;
        };
        renderPages();
        const hashChange = function() {
          const hash = window.location.hash.replace(/^#/, '');
          if (hash) {
            showPage(hash);
          } else {
            showPage(pages[0]?.id || 'page-1');
          }
        };
        window.addEventListener('hashchange', hashChange);
        hashChange();
      } catch (e) {
        console.error('Error initializing pages:', e);
      }
    })();
  <\/script>
</body>
</html>`},[Ie]);E.useCallback((e,s,o)=>{const n=(o||"Ziplofy Theme").replace(/</g,"&lt;").replace(/>/g,"&gt;"),r=s.split(`
`),d=[],f=[];r.forEach(c=>{const w=c.trim();w.startsWith("@import")?d.push(w):f.push(c)});const p=d.join(`
`)+(d.length>0?`

`:"")+f.join(`
`);return`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>${n}</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #1e1e1e;
      background: #ffffff;
    }
    * {
      box-sizing: border-box;
    }
    ${p}
  </style>
</head>
<body>
  ${e}
</body>
</html>`},[]);const De=E.useCallback(async e=>{try{const s=A.current;if(!s){alert("Editor not ready");return}ye(!0),await new Promise(l=>requestAnimationFrame(l)),await new Promise(l=>setTimeout(l,150)),s.trigger&&s.trigger("update");const o=s.getWrapper();o&&o.view&&o.view.render?.();let n="";try{o?(n=s.getHtml({component:o})||"",(!n||n.trim().length===0)&&(n=s.getHtml()||"")):n=s.getHtml()||"",(!n||n.trim().length===0)&&(console.warn("‚ö†Ô∏è No HTML from editor, using default"),n="<div>Empty Theme</div>")}catch(l){console.error("Error getting HTML from editor:",l),n=s.getHtml()||"<div>Empty Theme</div>"}let r="";const d=[];try{if(s.getCss){const l=s.getCss()||"";l&&l.trim().length>0&&(d.push(l),console.log("‚úÖ Method 1 - Standard getCss():",l.length,"chars"))}}catch(l){console.warn("Error getting CSS from editor.getCss():",l)}try{if(s.CssComposer){const l=s.CssComposer.getAll();if(l&&l.length>0){const m=l.map(u=>{try{if(u.toCSS)return u.toCSS();const N=u.selectorsToString?u.selectorsToString():u.getSelectors?u.getSelectors().join(", "):"",k=u.getStyle?u.getStyle():{};if(N&&k&&Object.keys(k).length>0){const T=Object.entries(k).map(([S,W])=>`  ${S}: ${W};`).join(`
`);return`${N} {
${T}
}`}return""}catch{return""}}).filter(Boolean).join(`

`);m&&m.trim().length>0&&(d.push(m),console.log("‚úÖ Method 2 - CssComposer:",m.length,"chars"))}}}catch(l){console.warn("Failed to get CSS from CssComposer:",l)}if(r=d.join(`

`),o){const l=o.getId();if(l&&r.includes(`#${l}`)){console.log(`üîß Converting wrapper ID selector #${l} to class .gjs-wrapper-body`);const m=new RegExp(`#${l}(?![a-zA-Z0-9_-])`,"g");r=r.replace(m,".gjs-wrapper-body"),console.log("‚úÖ Converted wrapper selectors to class-based")}}try{if(o){const l=o.getStyle?o.getStyle():null;if(l&&Object.keys(l).length>0){const u=`.gjs-wrapper-body {
${Object.entries(l).map(([N,k])=>`  ${N}: ${k};`).join(`
`)}
}`;r.includes(".gjs-wrapper-body")?r=r.replace(/\.gjs-wrapper-body\s*\{[^}]*\}/g,u):r=u+`

`+r,console.log("‚úÖ Method 3 - Wrapper styles:",Object.keys(l).length,"properties")}}}catch(l){console.warn("Failed to extract wrapper styles:",l)}try{const l=s.Canvas;if(l){const m=l.getFrameEl();if(m&&m.contentDocument){const u=m.contentDocument,N=u.querySelectorAll("style"),k=[];N.forEach($=>{$.textContent&&$.textContent.trim()&&k.push($.textContent)}),k.length>0&&(r+=`

/* Canvas Frame Style Tags */
`+k.join(`

`),console.log("‚úÖ Method 4a - Canvas frame style tags:",N.length));const T=u.querySelectorAll('link[rel="stylesheet"]'),S=()=>{const $={},R=localStorage.getItem("accessToken")||sessionStorage.getItem("accessToken")||localStorage.getItem("token")||sessionStorage.getItem("token");return R&&($.Authorization=`Bearer ${R}`),$},W=Array.from(T).map(async $=>{const L=$.href;if(L&&!L.startsWith("data:"))try{const F=await fetch(L,{credentials:"include",headers:S()});if(F.ok)return await F.text()||""}catch(F){return console.warn("Failed to fetch stylesheet:",L,F),`@import url('${L}');`}return""}),G=(await Promise.all(W)).filter($=>$.trim()).join(`

`);G&&(r+=`

/* Canvas Frame External Stylesheets */
`+G,console.log("‚úÖ Method 4b - Canvas frame stylesheets:",T.length));try{if(u.body){const R=Array.from(u.styleSheets),L=[];R.forEach(F=>{try{F.cssRules&&Array.from(F.cssRules).forEach(te=>{te.cssText&&L.push(te.cssText)})}catch{}}),L.length>0&&(r+=`

/* Computed Stylesheet Rules */
`+L.join(`

`),console.log("‚úÖ Method 4c - Computed stylesheet rules:",L.length))}}catch($){console.warn("Failed to extract computed stylesheet rules:",$)}}}}catch(l){console.warn("Failed to get CSS from canvas frame:",l)}if(z.current&&z.current.trim().length>0){const l=z.current.split(`
`),m=[],u=[];l.forEach(k=>{const T=k.trim();T.startsWith("@import")?m.push(T):u.push(k)}),r=m.join(`
`)+(m.length>0?`

`:"")+u.join(`
`)+`

/* GrapesJS Editor Styles */
`+r,r=r.replace(/color\s*:\s*#000000\s*;?/gi,"/* color removed - using original theme color */"),r=r.replace(/color\s*:\s*black\s*;?/gi,"/* color removed - using original theme color */"),r=r.replace(/color\s*:\s*rgb\(0,\s*0,\s*0\)\s*;?/gi,"/* color removed - using original theme color */"),console.log("‚úÖ Method 5 - Original theme CSS:",z.current.length,"chars",{imports:m.length,regularCss:u.length})}if((!r||r.trim().length===0)&&(console.warn("‚ö†Ô∏è WARNING: No CSS found! Using original theme CSS if available."),r=z.current||""),r.trim().length===0)throw console.error("‚ùå ERROR: No CSS content to save!"),new Error("No CSS content found. Cannot save theme without CSS.");const f={totalLength:r.length,hasOriginalCss:z.current&&z.current.length>0,originalCssLength:z.current?.length||0,hasImports:r.includes("@import"),hasWrapperStyles:r.includes(".gjs-wrapper-body"),hasBackgroundImages:r.includes("background-image")||r.includes("background:"),lineCount:r.split(`
`).length,preview:r.substring(0,500)};console.log("üì¶ Final CSS Statistics:",f),console.log("üì¶ Final CSS length:",r.length,"chars"),r.length<100&&console.warn("‚ö†Ô∏è WARNING: CSS content is very short. Theme may not display correctly.");const p=l=>{const m=[],u=/<img[^>]+src=["']([^"']+)["']/gi,N=/srcset=["']([^"']+)["']/gi,k=/background-image\s*:\s*url\(["']?([^"')]+)["']?\)/gi;let T;for(;(T=u.exec(l))!==null;){const S=T[1];S&&!S.startsWith("http")&&!S.startsWith("data:")&&!S.startsWith("#")&&!S.startsWith("mailto:")&&m.push(S)}for(;(T=N.exec(l))!==null;)T[1].split(",").forEach(W=>{const B=W.trim().split(/\s+/)[0];B&&!B.startsWith("http")&&!B.startsWith("data:")&&!B.startsWith("#")&&m.push(B)});for(;(T=k.exec(l))!==null;){const S=T[1];S&&!S.startsWith("http")&&!S.startsWith("data:")&&!S.startsWith("#")&&m.push(S)}return[...new Set(m.map(S=>S.startsWith("/")?S.substring(1):S))]};ee();const c=re.current.map(l=>l.id===_?{...l,html:n,css:r}:l),w=c.map(l=>l.css||"").filter(Boolean).join(`

`),t=pe(c,O||"My Theme",w),h=t.match(/<style[^>]*>([\s\S]*?)<\/style>/i),a=h?h[1].length:0;if(console.log("üì¶ Built export HTML:",{htmlLength:t.length,cssLength:r.length,embeddedCssLength:a,cssEmbedded:a>0,htmlPreview:t.substring(0,300),cssPreview:r.substring(0,200)}),a===0)throw console.error("‚ùå ERROR: CSS was not embedded in HTML document!"),new Error("CSS embedding failed. Cannot save theme without CSS.");a<r.length*.9&&console.warn("‚ö†Ô∏è WARNING: CSS length mismatch. Some CSS may be missing from HTML.");const g=p(t);console.log("üì∏ Found image references:",g);const v=await $e(O||"My Theme"),y=D&&/^[0-9a-fA-F]{24}$/.test(D),C=ae==="installed";let x=D||"";if(y&&!C)try{const l=await Ce(D,O||"My Theme",t,r,v);if(l)x=l._id;else{const m=await ie(O||"My Theme",t,r,v);if(m){x=m._id;const u=new URL(window.location.href);u.searchParams.set("id",x),u.searchParams.delete("type"),window.history.replaceState({},"",u.toString())}}}catch(l){if(l?.response?.status===404){const m=await ie(O||"My Theme",t,r,v);if(m){x=m._id;const u=new URL(window.location.href);u.searchParams.set("id",x),u.searchParams.delete("type"),window.history.replaceState({},"",u.toString())}}else throw l}else{console.log("Creating new theme...",{name:O||"My Theme",htmlLength:t.length,cssLength:r.length,hasThumbnail:!!v});const l=await ie(O||"My Theme",t,r,v);if(!l)throw console.error("createTheme returned null - check console for error details"),new Error("Failed to create theme. Check console for details.");x=l._id;const m=new URL(window.location.href);m.searchParams.set("id",x),m.searchParams.delete("type"),window.history.replaceState({},"",m.toString())}ye(!1),e&&(localStorage.setItem("ziplofy.appliedCustomThemeId",x),je(!0),setTimeout(()=>je(!1),3e3))}catch(s){ye(!1),console.error("Error saving theme:",s),console.error("Error details:",{message:s?.message,response:s?.response,status:s?.response?.status,data:s?.response?.data,code:s?.code});let o="Failed to save theme";s?.code==="ECONNABORTED"||s?.message?.includes("timeout")?o="Upload timeout: The theme is very large. Please try again or reduce the theme size.":s?.response?.status===400?(o=s?.response?.data?.message||"Bad Request: Invalid theme data. Please check the console for details.",console.error("400 Bad Request details:",s?.response?.data)):s?.response?.status===500?o="Server error: The theme might be too large or there was a server issue. Please try again or reduce the theme size.":s?.response?.status===413||s?.message?.includes("File too large")||s?.message?.includes("MulterError")?o="Theme too large: The theme exceeds the maximum size limit (500MB). Please reduce the size of your theme content.":s?.response?.data?.message?o=s.response.data.message:s?.message&&(o=s.message),alert(o)}},[D,ae,O,ie,Ce,pe,$e,ee,_]),Ze=()=>{De(!1)},Ye=()=>{De(!0)},Ke=E.useCallback(async()=>{try{const e=A.current;if(!e||typeof e.getHtml!="function"){alert("Editor not ready");return}e.trigger&&e.trigger("update");const s=e.getWrapper();s&&s.view&&s.view.render?.();let o="";try{s?(o=e.getHtml({component:s})||"",(!o||o.trim().length===0)&&(o=e.getHtml()||"")):o=e.getHtml()||"",(!o||o.trim().length===0)&&(console.warn("‚ö†Ô∏è No HTML from editor, using default"),o="<div>Empty Theme</div>")}catch(c){console.error("Error getting HTML from editor:",c),o=e.getHtml()||"<div>Empty Theme</div>"}let n="";const r=[];try{if(e.getCss){const c=e.getCss()||"";c&&c.trim().length>0&&r.push(c)}}catch(c){console.warn("Error getting CSS from editor.getCss():",c)}try{if(e.CssComposer){const c=e.CssComposer.getAll();if(c&&c.length>0){const w=c.map(t=>{try{if(t.toCSS)return t.toCSS();const h=t.selectorsToString?t.selectorsToString():t.getSelectors?t.getSelectors().join(", "):"",a=t.getStyle?t.getStyle():{};if(h&&a&&Object.keys(a).length>0){const g=Object.entries(a).map(([v,y])=>`  ${v}: ${y};`).join(`
`);return`${h} {
${g}
}`}return""}catch{return""}}).filter(Boolean).join(`

`);w&&w.trim().length>0&&r.push(w)}}}catch(c){console.warn("Failed to get CSS from CssComposer:",c)}if(n=r.join(`

`),s){const c=s.getId();if(c&&n.includes(`#${c}`)){const w=new RegExp(`#${c}(?![a-zA-Z0-9_-])`,"g");n=n.replace(w,".gjs-wrapper-body")}}try{if(s){const c=s.getStyle?s.getStyle():null;if(c&&Object.keys(c).length>0){const t=`.gjs-wrapper-body {
${Object.entries(c).map(([h,a])=>`  ${h}: ${a};`).join(`
`)}
}`;n.includes(".gjs-wrapper-body")?n=n.replace(/\.gjs-wrapper-body\s*\{[^}]*\}/g,t):n=t+`

`+n}}}catch(c){console.warn("Failed to extract wrapper styles:",c)}try{const c=e.Canvas;if(c){const w=c.getFrameEl();if(w&&w.contentDocument){const t=w.contentDocument,h=t.querySelectorAll("style"),a=[];h.forEach(l=>{l.textContent&&l.textContent.trim()&&a.push(l.textContent)}),a.length>0&&(n+=`

/* Canvas Frame Style Tags */
`+a.join(`

`));const g=t.querySelectorAll('link[rel="stylesheet"]'),v=()=>{const l={},m=localStorage.getItem("accessToken")||sessionStorage.getItem("accessToken")||localStorage.getItem("token")||sessionStorage.getItem("token");return m&&(l.Authorization=`Bearer ${m}`),l},y=Array.from(g).map(async l=>{const u=l.href;if(u&&!u.startsWith("data:"))try{const N=await fetch(u,{credentials:"include",headers:v()});if(N.ok)return await N.text()||""}catch(N){return console.warn("Failed to fetch stylesheet:",u,N),`@import url('${u}');`}return""}),x=(await Promise.all(y)).filter(l=>l.trim()).join(`

`);x&&(n+=`

/* Canvas Frame External Stylesheets */
`+x)}}}catch(c){console.warn("Failed to get CSS from canvas frame:",c)}if(z.current&&z.current.trim().length>0){const c=z.current.split(`
`),w=[],t=[];c.forEach(a=>{const g=a.trim();g.startsWith("@import")?w.push(g):t.push(a)}),n=w.join(`
`)+(w.length>0?`

`:"")+t.join(`
`)+`

/* GrapesJS Editor Styles */
`+n}(!n||n.trim().length===0)&&(n=z.current||""),ee();const d=re.current.map(c=>c.id===_?{...c,html:o,css:n}:c),f=d.map(c=>c.css||"").filter(Boolean).join(`

`),p=pe(d,O||"Theme Preview",f);console.log("‚úÖ Preview HTML built:",{htmlLength:p.length,cssLength:n.length,containsCss:p.includes("<style>")}),Ee(""),setTimeout(()=>{Ee(p),be(!0),setTimeout(()=>{const c=document.getElementById("basic-elementor-preview-iframe");c&&c.contentDocument&&p&&(c.contentDocument.open(),c.contentDocument.write(p),c.contentDocument.close(),console.log("‚úÖ Forced iframe content update"))},100)},50)}catch(e){console.error("Preview error:",e),alert("Failed to preview theme")}},[O,pe,z,_,ee]),Qe=["Hero section","Logo banner","Collection list: Grid","Product highlight","Product card","Featured collection","Collection list: Carousel","Marquee"];return i.jsxs("div",{className:"basic-elementor-container",children:[i.jsxs("div",{className:"basic-elementor-toolbar",children:[i.jsxs("div",{className:"toolbar-left",children:[i.jsx("button",{onClick:()=>ze("/themes/all-themes"),className:"back-button",children:"‚Üê Back"}),i.jsx("div",{className:"theme-name",children:O||"Editing Theme"}),Te.length>1&&i.jsx("div",{className:"page-dropdown-wrapper",children:i.jsx("select",{value:_,onChange:e=>Ge(e.target.value),className:"page-dropdown",title:"Select page",children:Te.map(e=>i.jsx("option",{value:e.id,children:e.name},e.id))})})]}),i.jsx("div",{className:"toolbar-center",children:i.jsxs("div",{className:"device-selector",children:[i.jsx("button",{className:`device-btn ${U==="desktop"?"active":""}`,onClick:e=>{e.preventDefault(),e.stopPropagation();const s=e.nativeEvent;s&&typeof s.stopImmediatePropagation=="function"&&s.stopImmediatePropagation(),console.log("üñ•Ô∏è Desktop button clicked"),U!=="desktop"&&fe("desktop")},title:"Desktop View",type:"button","aria-label":"Switch to Desktop View",children:i.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[i.jsx("rect",{x:"2",y:"3",width:"12",height:"9",rx:"1",stroke:"currentColor",strokeWidth:"1.5",fill:"none"}),i.jsx("path",{d:"M5 12h6",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round"})]})}),i.jsx("button",{className:`device-btn ${U==="tablet"?"active":""}`,onClick:e=>{e.preventDefault(),e.stopPropagation();const s=e.nativeEvent;s&&typeof s.stopImmediatePropagation=="function"&&s.stopImmediatePropagation(),console.log("üì± Tablet button clicked"),U!=="tablet"&&fe("tablet")},title:"Tablet View",type:"button","aria-label":"Switch to Tablet View",children:i.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:i.jsx("rect",{x:"4",y:"2",width:"8",height:"12",rx:"1",stroke:"currentColor",strokeWidth:"1.5",fill:"none"})})}),i.jsx("button",{className:`device-btn ${U==="mobile"?"active":""}`,onClick:e=>{e.preventDefault(),e.stopPropagation();const s=e.nativeEvent;s&&typeof s.stopImmediatePropagation=="function"&&s.stopImmediatePropagation(),console.log("üì± Mobile button clicked"),U!=="mobile"&&fe("mobile")},title:"Mobile View",type:"button","aria-label":"Switch to Mobile View",children:i.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[i.jsx("rect",{x:"5",y:"1",width:"6",height:"14",rx:"1",stroke:"currentColor",strokeWidth:"1.5",fill:"none"}),i.jsx("circle",{cx:"8",cy:"13",r:"1",fill:"currentColor"})]})})]})}),i.jsxs("div",{className:"toolbar-right",children:[i.jsx("button",{onClick:Ve,className:"toolbar-btn",title:"Undo",children:i.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",children:i.jsx("path",{d:"M3 8h8M3 8l3-3M3 8l3 3",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"})})}),i.jsx("button",{onClick:Je,className:"toolbar-btn",title:"Redo",children:i.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",children:i.jsx("path",{d:"M13 8H5M13 8l-3-3M13 8l-3 3",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"})})}),i.jsx("button",{onClick:Ke,className:"preview-btn",title:"Preview Theme",children:"Preview"}),i.jsx("button",{onClick:Ze,className:"save-btn",disabled:ce,children:ce?"Saving...":"Save"}),i.jsx("button",{onClick:Ye,className:"publish-btn",disabled:ce,children:ce?we?"Published!":"Publishing...":we?"Published!":"Publish"}),we&&i.jsx("div",{style:{position:"absolute",top:"100%",right:0,marginTop:"8px",padding:"8px 16px",background:"#008060",color:"white",borderRadius:"6px",fontSize:"13px",whiteSpace:"nowrap",zIndex:1e3},children:"Theme published successfully!"})]})]}),i.jsxs("div",{className:"basic-elementor-content",children:[He&&!Q&&i.jsxs("div",{className:"basic-elementor-sidebar",children:[i.jsx("div",{className:"sidebar-section",children:i.jsx("div",{className:"sidebar-title",children:"Home page"})}),i.jsxs("div",{className:"sidebar-section",children:[i.jsxs("div",{className:"sidebar-section-header",onClick:()=>ve("header"),children:[i.jsx("span",{className:"section-title",children:"Header"}),i.jsx("span",{className:"section-toggle",children:X.header?"‚ñº":"‚ñ∂"})]}),X.header&&i.jsxs("div",{className:"sidebar-section-content",children:[i.jsxs("div",{className:`section-item ${K==="Header"?"selected":""}`,onClick:()=>he("Header"),children:[i.jsx("span",{children:"Header"}),i.jsx("button",{className:"section-edit-btn",onClick:e=>me("Header",e),title:"Edit styles",children:"Edit"})]}),i.jsx("button",{className:"add-section-btn",children:"Add section"})]})]}),i.jsxs("div",{className:"sidebar-section",children:[i.jsxs("div",{className:"sidebar-section-header",onClick:()=>ve("template"),children:[i.jsx("span",{className:"section-title",children:"Template"}),i.jsx("span",{className:"section-toggle",children:X.template?"‚ñº":"‚ñ∂"})]}),X.template&&i.jsxs("div",{className:"sidebar-section-content",children:[Qe.map((e,s)=>i.jsxs("div",{className:`section-item ${K===e?"selected":""}`,onClick:()=>he(e),children:[i.jsx("span",{children:e}),i.jsx("button",{className:"section-edit-btn",onClick:o=>me(e,o),title:"Edit styles",children:"Edit"})]},s)),i.jsx("button",{className:"add-section-btn",children:"Add section"})]})]}),i.jsxs("div",{className:"sidebar-section",children:[i.jsxs("div",{className:"sidebar-section-header",onClick:()=>ve("footer"),children:[i.jsx("span",{className:"section-title",children:"Footer"}),i.jsx("span",{className:"section-toggle",children:X.footer?"‚ñº":"‚ñ∂"})]}),X.footer&&i.jsxs("div",{className:"sidebar-section-content",children:[i.jsxs("div",{className:`section-item ${K==="Footer"?"selected":""}`,onClick:()=>he("Footer"),children:[i.jsx("span",{children:"Footer"}),i.jsx("button",{className:"section-edit-btn",onClick:e=>me("Footer",e),title:"Edit styles",children:"Edit"})]}),i.jsxs("div",{className:`section-item ${K==="Logo"?"selected":""}`,onClick:()=>he("Logo"),children:[i.jsx("span",{children:"Logo"}),i.jsx("button",{className:"section-edit-btn",onClick:e=>me("Logo",e),title:"Edit styles",children:"Edit"})]}),i.jsx("button",{className:"add-section-btn",children:"Add section"})]})]})]}),Q&&i.jsxs("div",{className:"style-editor-panel",children:[i.jsxs("div",{className:"style-panel-header",children:[i.jsx("button",{className:"back-to-structure-btn",onClick:()=>{oe(!1),ne(!0);const e=A.current;e&&e.select(null)},title:"Back to Structure",children:"‚Üê Back"}),i.jsx("div",{children:i.jsxs("h3",{children:["Styles",K?`: ${K}`:""]})})]}),i.jsx("div",{className:"style-panel-content-wrapper",id:"style-panel-wrapper"})]}),i.jsxs("div",{className:"basic-elementor-preview",children:[We&&i.jsxs("div",{className:"loading-overlay",children:[i.jsx("div",{className:"loading-spinner"}),i.jsx("div",{children:"Loading theme..."})]}),ke&&i.jsx("div",{className:"error-overlay",children:i.jsx("div",{children:ke})}),i.jsx("div",{ref:le,id:"gjs-editor-container",style:{height:"100%",width:"100%",minHeight:0,position:"relative"}})]})]}),Oe&&i.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1e5,background:"rgba(0, 0, 0, 0.9)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},onClick:()=>be(!1),children:i.jsxs("div",{style:{width:"95%",height:"95%",background:"#fff",borderRadius:"8px",display:"flex",flexDirection:"column",position:"relative"},onClick:e=>e.stopPropagation(),children:[i.jsxs("div",{style:{padding:"16px 20px",borderBottom:"1px solid #e5e7eb",display:"flex",justifyContent:"space-between",alignItems:"center",background:"#f9fafb",borderRadius:"8px 8px 0 0"},children:[i.jsx("h3",{style:{margin:0,fontSize:"16px",fontWeight:600,color:"#111827"},children:"Theme Preview"}),i.jsx("button",{onClick:()=>be(!1),style:{padding:"6px 12px",border:"1px solid #d1d5da",background:"#fff",color:"#111827",borderRadius:"6px",cursor:"pointer",fontSize:"14px",fontWeight:500},children:"Close"})]}),i.jsx("iframe",{id:"basic-elementor-preview-iframe",srcDoc:de,style:{width:"100%",height:"100%",border:"none",background:"#fff",flex:1},title:"Theme Preview",sandbox:"allow-scripts allow-same-origin allow-forms allow-popups allow-presentation",onLoad:e=>{const s=e.target;s&&s.contentDocument&&de&&(s.contentDocument.open(),s.contentDocument.write(de),s.contentDocument.close())}},`preview-${Date.now()}-${de.length}`)]})})]})};export{ht as default};
